language: minimal
services:
  - docker
branches:
  only:
    - qa
    - production
    - DR-2564-production-travis
env:
  global:
    - AWS_DEFAULT_REGION=us-east-1
    - LOCAL_TAG_NAME=dc-frontend:$TRAVIS_BRANCH-$TRAVIS_BUILD_NUMBER
    # DOCKER_LOGIN_PASSWORD
    - secure: "PWBKqzoehtHm6yDnQ85goSvBlnqE+N+DSesKtElIggKJGewGvHuSUWItYClBRIpbSPcm/5mn8yabhLPz37sJo7nJY/hJHQyGk8dwZtQcLBxVMSq4vMd6EbgeqZeT4oMWzQsT3TpLvESfSyEZu9MNzpKdFdxugOPKk0vUIDFTvBHpRtb+peptLqXBOXeo5czOJQta+QuQr3vd3PIUCYCoCGgx2ueoakIJXxpsNOe1/UHj97gbMlIypD+OdyCp3MQMn5etYFC/98HhTMGKrB8PI6qM/XdEzPzdw9zQjiDMq2xInQImgEFDymBwFfmIz8cEbjNiVnXxjnyfFgD5stmNHNi77rx2LF4MRlbEO7i9jZU7u1KfF+ruEnfYosZLgNKR+1JpeOr8Wvpe2yu/z7vMbeB9l1KvfGNLcRcA9M9kQigDwJJSCiIXj3d+KMoEy01Y5j8Nn18EOkEcOLSPrKBOsiH1y7zT/Ahnk17KIDkbPwiLyixwIjyhMRyVEp9FDjkBCrI93NZxYr3lyGaHSO8ZLHpi7v1NZcBxuNBlyhD+sHjkSdMZXaDBUJ73L7RVHCgdDYI2DP8PzbQ9yiM+6v2XTAbDHd6SMRW86+0K976i47mqAKKqWBLD1JuqYz01ZYTNVBR7UPkD3xS2elDlWeXJo7OKoZOgn2UrUvs4MlMY9Ko="
 - secure: "h9EWW52yHhzoUCoiECJ5UoNBtLOeDy+hoMFNsxzHevHxlosjKtokpO3tQnfPo0gpxG0IQV1wEJYw7adaMex//QLCGnLLxzdPaICQ4WOcdlEqDT3SyqNcjmUf1uk1HVHM6Od6Y5KV0AHzkL/RosR3iCKjrhrgjXm10LhBoSJSX6M82C/bULSr/aBoK0ZDxDM6Z44RwaDiuGJxlUy9+xe7K/j55ZWgT14nvZLygLcKeKdtMBHDDRdKMCvC5x/WNAndyY70u+QBGL99+fjLnX85lnOPNejz/8EGCWFT8V2c0FtlQthXuwWL159TA1PM/UNcJ7RB8ykTww7n5cekdLuaYQbK6thptRhPkWXPVy/WPpjQhvXSDnMx8gkH+mV7H6WI3psUH5209YG1HLec+8nuvzsgrUFu0Xct3jdlzTfJtKa1TniUB5gGfR5+jpjJv2JAFC4oyAzLfZ32w2cV4ANjwSRdLOdVKYS8CPWCDopg0m+xnx56To+SUT+BYDEAXf7c2pjaU/mn0RRi42Xm2VqmkqpltwCp3l4WeW4WkqbOBxwsIp9cLojmXzKpjMEE9sZ/MzjrCENTdppx+0iwrC2JqAu05cTGuHF67K3farKTI65c8ffrTDYfX5SG5ycJXQho4gcoEdCRjHDs2qXbFSrDz2+m8IfY3pQHEk/O2Y0V2lc=" # AWS_ACCESS_KEY_ID_QA nypl-dams-dev 20240130
    - secure: "sTrjgmIo5lRW45LkC6Ou/3vp6l6i5LQC83asS3XxnwGWBCi1mZ9Q20v2o372NAtcsqJxgUCfyNWlVsNOXVhapDRYi6s8oOvtN0pPl3Y/LGQ01qtLFvOuKkEtIsjasg5C/9k5WQHNDx8CLnJ1TU9oPT+8XQShaTZYWFhrSZQ/qyD1zCk7uYW/CsUh+AvXm4ktapIve9/bMjJTbTe45dtNa+1Y39VlQvbNnkKIjmncWH5qcVAuNocY0Lh1PINVnK/FhD8vhVsxwj4N5UAPn3peg6n3G/MMryT16Y51CsQwhZkQerFvWIz4U5H7TXn81UcwStyOL92R5MupEes7H9XHAe48GHeRBhnyuvsK/n1CBz4ck0b2JyTWkGBjgr41uAOEqTE2XsolBW6XCQQ4M8rrMf87S7K1VMXi1Vp8SqhP4Rlp2Wsyx1xl/nM7LtF0e+IR/uzxPsa7mLU9Jnj4ARCMwufTv+f60cxNZuZtT2A8kgvmiCbgMsCN5doqLRXE9qlgBrEDN8Xos8s0S0nUaWEehuwm7OXpq2KqekyaMRmPQcApWjfQXxlnXX5y1Lld7MSgsUa+OtxodWHtTOhG8hU8D/RBRbMRKm13sENwlKKFv54j9LjxwdEK9tYherIgGZwQHhc1Yb9CyqVkFi+dP9HXEUIMt9QHY48R+J/aLwxF+3s="
 - secure: "NdYSW/sL35ds/ES7Z5Q1aTl1e3BQaBMVSMZVfhJedQ4vGsaWXEWS78k2SYfwxOtPT8mjJfaX17SAlsAaLC5YCk7dfLled9K3zX2444EZu8o2mlMOUT7fO1UgW+F6B+YIU3C+jG2KIqbGl2Cyoi/DuTATkM0sP2LHgxKdBBEiLE3ZSwChhhqjjiXUYdV1qIUmay7D4HWm39dwSLTSgFHIB9bXrVdwO4wlqyRmnKzIbezmyYoCI586WBzO6RYUy/3I+PxazL9OgnuASE0Xx+ecBs6j7+uTYMQczZgFfAFVAC0mrNt3utNy84j/pML8TOCISOPvMxCC05mgDUBaaxmH5d8mX9wZ1P6fRwpkQt+gIukSk3TPlGDCtVnsSvVB19nY6AVdCcHyMW/Uwxof8+0ETBNr74mJilaY+YC5swWTGjGY0srwlsKzoELTkcpioMylxibU4+Wl7xZgrwUv3oxzu0saakJlS00I07XhNlVyE1yKWUnGCTaqSmvGVQiXLfYe5pHx/ziUmPQl3g0y5Ch0M0RIF/zJUOB+OJOuHue+ShXf+2Lnl5uOjqQCrz17Dha9litCqxRi0ePuzZJrWSY7hukQ42ZUS6BOVaJk0sF8hoUEZCODJMbBRekIJtxEZw3z8tIYwTi81zJDPYDkQjqs/txh6Shhn2C4OsnbEL+WubU=" # AWS_SECRET_ACCESS_KEY_QA nypl-dams-dev 20240130
    - secure: "PciR0AAEaOFZheL77pXENbsrevAFhtbb42FMrKB6hZgCbqkrJ9QoRGtd4JH3Ll557Qn2gWoYmWPC3gfO2TWcCTRRQ1VcgqFIqIKzM/D/Fj3Dhufv+PXsymGmP6bkU89LyEyWt5OxkkkhF0ZXuk/ucRF3mQHqVRGBINj6dQfSPKsZV7Eg9tZrTLP583Yk+n9+PEqRffeYJlZqPBrTkf5pJZgZ5vrk4d/dD+2Jzld66ETZttfGu1g7JfTx1fA8uSlOw7AnYB/2Wy+iFeMpvwju0WR5EU4BOa50CJS5abT8/Ujt3I0oMB/BM8hQtMZoq4dBtGJumbfALDdXhjO1IppbaJHES4fmJOtauErOtCWBk/VarAZ/aFV9/Eo3MlrIVmycD6QZDkCuAHqYTz1NCbtud5YEXOtFySyOXUbuxQ7l2kR8hDf4mjTAK8UaLyX7y3RIrWOwV651ivUGiIpJ7OyyDrWNxZIRj7TGQITT5MolqLBk8t5fuNivR1znqHoFEClAzqd2H/F3+pjUJvAi7+/PSIgjGDo90FHHnS0u7R1q/35MVlC8K5DX/NjJyUZCJB1LWE6Ver5EFjLbDI3WPy0DQh8URH70goO/XiWGkMhit6exmxFB4sDO0XpcZ+g67vv82doeBuCPd8ukc6wV2vZIfSc+y8KJXMY9eZ7NBiQu/lE="
 - secure: "SrUCreAdqUsABFdG8KmaZ3ni/opDKLdJoF9JKlTCPa8wDiTkMBXP6kGuPo0gS0/yEABvPaPHs/pPUvr+pEGGGDYdfo2MJVn6ca+x/f8YSLC+ZtQHzA77XCRFqn/aXvj7hg/QtAz1bi37naobJt2/nkhX5PUVICJYtMeofw1R+D/7QdN2Z6+Jg1lST5/lHD7lxKYoO+fk25z9rzTppkRYqf8bgtPudfMrU/PV4ip/cBOD+QboCa0JJ0aIOX6tdpqtnaZuxQ0LUY5J0bEAGLAxKt1bh2x/wdVxocv7bm+b/6//dUsKSA0WzvYebpJPLuUC0F97iB6QnLq+U21YVPTxUMMnmYE0vfK+iZrBbt0WcnqBRv0TXeVIY9+4vdHFE8rjtbIlNJJ6KhmxhwlsDj5cWg2TI9OXTYstGWPH6wLq7idTB2hnBjFm9dcYC/rXKq49ctSOnTxr3LcJOljR0VoVskCjz539aO2BKqdkYIqiPeJAYiJGxGsqD1MnKhxCtgtsJz2s8s7whPyJoxS5I4Icgbq9CkhMvjOFWR2L4cezU+gZ2NtlDahjgIFJvX0U8d4rD6+I3sxkMH8pKTbT3i52pJXUNgC8I8p0J1ISi1yQBg1Fr4jneGCKZaYcC+7aEwq63E8uO7gpykcb1VdHxBX2trUDhYZpTKP7+DLRxOhdaro=" # AWS_ACCESS_KEY_ID_PRODUCTION nypl-dams-prod 20240130
    - secure: "AxFeC1wLt0j7Gu8Kh5h6KHMCbl2COq0CxZjKl/w+QLtTCZuqCB6DiIoFA9rlmf+2v3Ixt84rcnpcD6u2ABUqaF0O18MemeAXGhSovlHgGM9E74vivJWSv0oEiXP1mVe3P0cRgHqfZO5h40rAX48rMmQNlbh/BHAqftaEnFGGsvojjKPdwKycB1GeP9TSgsVzGQ95H5XcKMZGaC5mV5WaahEQLKYCaw81SO4OSQknIFzJP8bESIhyF+JAhN42L7biE4uA3eCCbhz+Schw7H7CKMgkdSI9GaPEl2BwP2sPrddfvAIJSdptJo9UIMVlELnsq87uensWpYq0NcnmktNQiEilkgUVGbJCuyLtkAffAXXqHPNA1oWCncfN6ix91ADoY241MAiI6OhyHtJmOby4xcUgUCoVlxnTWchHOO4ciqp/w2Wu/WEjetBMqicB+nsD8i+RT9ovVVjMiBD1GWTFe31psb57ObTIZpestUCEp/91gzggbedMbjJnMu/CAs3SVdOxFppeeP9bWTgJq3QYGqxeDehuDN+0Ax7QM25t/D2Bq7hTZIIKpFOp0Q8SpABva4UYVeR/O7/O0ihfvkeqM0FWfCrteya4PiHP79qX3Cxrd/HEH5wCKgF53p3TRkaES/TOisqm/bIlrkMWJ697Fx5XLvS1vUlvXiyOjo4lAeE="
 - secure: "1IIXIHfqC5juveVpgz/6ObCVbT/gugXNNmdTbhWgPY8LREvDywru645WPb+98igy6e7F8bBrJs6tdlCJ38cVWSf4sN5aeAOxngA3aGasHystS2V82AFQVlDnPcQ7T3OZTzOyysym5D+9FUTbb0MkbbA1npuLb4Omc1oh387625x9rzKJUdzkqw2IcCWiy8zKlvTP4538MfrEMGDsxd1tCCJu4YmyuEsCvB8m5/PDL9VXJU/kyj17BuE9enH0tgsYFj2cpQvFaBMski6kQxJu9ww7zYayBNmO05XIKCyJjkts+tyoEkn8iSWDowQJnlNFRzDhb4vQ2v6hCOaX4SrIHougmr+ELsSZF90g6PAuTb0SqzW73GARKRRVjGqq2QS7qyJUKaCQJKRxxZ+JtYhc49/Nj2PijJsaw6rq+t9mfREk+BFkQEKyN2Qwp/TLkRGgFmZCtd+LQ9LUVuJ8yCqYoSTpG0ht0oz1Plh+ZB/oaul/6M+gMlye59OI+32eWiwHTIU/Yqkr+3k1uuNbjAYqJBtt60D2J7YvYdojZrW1RAPlkSBqlvLvnE+UuTted+8XVynaXk1HHI3+xkSPhMK1pLfJuaZWalQAfetUlr0kSWc9aStr6MdzT38gZszaC7sWjjHQzAy0tlv4BUlg41I9AasKFSBXN5A+sxNs0gvAQew=" # AWS_SECRET_ACCESS_KEY_PRODUCTION nypl-dams-prod 20240130
    - secure: "UnlYqYBdutWVV00V03djajabghAg9ZpryG3cUYeBfTIrhzGitLmXzSUgLdUKMRe/dlevAHOdYQrmilKzMk/ldcJ4H7n0kXZ7LtQG89BRlUXTK+gZ3qHM0XHVB/LFQA0EFxn31uNGdJ3taEg3vwOA5DrV/iSbRJn86vpwt+4FuocAjU2rHpQWDvfX/CGmV6gLdzaRe2HVpumjnvEBr7KX/I4eKLTIiKtNAlBv09EorQGYFpiJUY3S+ii3KcE9gJZVm7A4IWSgc+O5lUhOnpS2OGZ/altxUJdFPWAtUfIQoDLUQAZRCIZm/ixzFr1azue0dCxDJr40JOmSCkqBnhIGNDvyO9OelaGM1wmG29IWNTxdbtTWl288P5Ni5hhfbhSKBgPA2IdAFa2HwX2czL+7/3aPzHoiNf1qvHOe2tS2XGsfdpWz29NKJ+4UVT2rqpL1mDBv4fOiT8Y1k3gQcMgHFu6xzGet/bdmLo8Xr/wC/O6D/PUTlCeAxXz9Cv3q4v37q8FLTSL1fOEuTFQROpHAqRV/sqPNNaobdRRZPjaA1mp96JoPEEHbqoLt82GSeTzYBFC8HagEdQvF+9YqEr+/ydTF9ysQbOcFNqZQX3q0/O5byd6JZzaFcZaq75HsT9vi911RR66GYPfMQGqZsNTBsSNCvXx0KCS9KraN4kg1ck4="
jobs:
  include:
    - stage: deploy QA
      if: (branch = qa) AND (type != pull_request)
      env:
        - ECR_URL=685731035297.dkr.ecr.us-east-1.amazonaws.com/dc-frontend:$TRAVIS_BRANCH-latest
        - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
        - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
        - CLUSTER_NAME=dc-frontend-qa
        - SERVICE_NAME=dc-frontend-qa
      install:
        - pip install --user awscli
      script:
        - eval $(aws ecr get-login --no-include-email)
        - docker build --tag "$LOCAL_TAG_NAME" .
        - docker tag "$LOCAL_TAG_NAME" "$ECR_URL";
        - docker push "$ECR_URL";
        - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --force-new-deployment
    - stage: deploy production
      if: (branch = production) AND (type != pull_request)
      env:
        - ECR_URL=557492996044.dkr.ecr.us-east-1.amazonaws.com/dc-frontend:latest
        - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
        - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
        - CLUSTER_NAME=dc-frontend
        - SERVICE_NAME=dc-frontend
      install:
        - pip install --user awscli
      script:
        - eval $(aws ecr get-login --no-include-email)
        - docker build --tag "$LOCAL_TAG_NAME" .
        - docker tag "$LOCAL_TAG_NAME" "$ECR_URL";
        - docker push "$ECR_URL";
        - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --force-new-deployment
